<div class="fc-premium-bg min-h-screen px-4 py-8">
  <div class="max-w-6xl mx-auto">
    <div class="mb-8">
      <app-back-button fallbackRoute="/backoffice/audit"></app-back-button>
    </div>

    <header class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
      <div>
        <h1 class="text-2xl sm:text-3xl font-bold text-white tracking-tight">Backoffice KYC</h1>
        <p class="text-sm text-white/60 mt-1">Validation des niveaux KYC (0/1/2) · Provisioning wallet</p>
      </div>
      <button type="button" class="bo-btn" (click)="refresh()" [disabled]="loading()">Rafraîchir</button>
    </header>

    <div class="bo-card mb-6">
      <div class="flex flex-col sm:flex-row gap-3 items-start sm:items-end">
        <div class="w-full sm:w-96">
          <label class="block text-sm font-medium text-white/70 mb-2">Recherche (email, nom, entreprise, id)</label>
          <input class="bo-input" [ngModel]="q()" (ngModelChange)="q.set($event)" placeholder="souhail, esprit, ..." />
        </div>
        <button type="button" class="bo-btn bo-btn-primary" (click)="refresh()" [disabled]="loading()">Chercher</button>
      </div>
    </div>

    @if (error()) {
      <div class="bo-error mb-6">{{ error() }}</div>
    }

    @if (actionMsg()) {
      <div class="bo-success mb-6">{{ actionMsg() }}</div>
    }

    @if (loading()) {
      <div class="bo-card flex items-center justify-center py-16">
        <div class="flex flex-col items-center gap-3">
          <div class="bo-spinner"></div>
          <span class="text-sm text-white/70">Chargement…</span>
        </div>
      </div>
    }

    @if (!loading()) {
      <div class="bo-card overflow-x-auto">
        <table class="bo-table">
          <thead>
            <tr>
              <th>Utilisateur</th>
              <th>Type</th>
              <th>KYC</th>
              <th>Wallet</th>
              <th class="text-right">Actions</th>
            </tr>
          </thead>
          <tbody>
            @for (u of rows(); track u.id) {
              <tr>
                <td>
                  <div class="font-medium text-white">{{ u.email }}</div>
                  <div class="text-xs text-white/50 font-mono break-all">{{ u.id }}</div>
                  <div class="text-xs text-white/50">Créé: {{ u.createdAt ? (u.createdAt | date:'yyyy-MM-dd HH:mm') : '-' }}</div>
                  <div class="text-xs text-white/50">Résidence: {{ u.resident === null ? '-' : (u.resident ? 'Tunisien' : 'Non-résident') }}</div>
                </td>
                <td class="text-white/70">{{ u.type ?? '-' }}</td>
                <td>
                  <span class="inline-flex px-2 py-1 rounded-lg text-xs font-semibold" [class]="badge(u.kycLevel).cls">
                    {{ badge(u.kycLevel).label }}
                  </span>
                  <div class="text-xs text-white/50 mt-1">Validé: {{ u.kycValidatedAt ? (u.kycValidatedAt | date:'yyyy-MM-dd HH:mm') : '-' }}</div>
                </td>
                <td>
                  @if (u.walletAddress) {
                    <div class="font-mono text-xs break-all text-white/80">{{ u.walletAddress }}</div>
                  } @else {
                    <span class="text-xs text-white/50">Non provisionné</span>
                  }
                </td>
                <td class="text-right">
                  <div class="inline-flex flex-col gap-2 items-end">
                    <div class="flex items-center gap-2">
                      <input
                        class="w-20 px-2 py-1 rounded text-xs bo-input"
                        [ngModel]="scoreByUserId()[u.id]"
                        (ngModelChange)="onScoreChange(u.id, $event)"
                        placeholder="Score"
                        inputmode="numeric"
                      />
                      <button type="button" class="bo-btn bo-btn-primary text-xs px-3 py-1.5" (click)="setScore(u)" [disabled]="loading() || !u.walletAddress" title="Pousser setScore">
                        setScore
                      </button>
                    </div>
                    <div class="flex flex-wrap gap-1 justify-end">
                      <button type="button" class="bo-btn text-xs px-2 py-1" (click)="setLevel(u, 0)" [disabled]="loading() || !canSet(u, 0)">KYC0</button>
                      <button type="button" class="bo-btn text-xs px-2 py-1 border-amber-500/50 text-amber-300" (click)="setLevel(u, 1)" [disabled]="loading() || !canSet(u, 1)">KYC1</button>
                      <button type="button" class="bo-btn text-xs px-2 py-1 border-green-500/50 text-green-300" (click)="setLevel(u, 2)" [disabled]="loading() || !canSet(u, 2)">KYC2</button>
                    </div>
                  </div>
                </td>
              </tr>
            } @empty {
              <tr>
                <td colspan="5" class="py-10 text-center text-white/50">Aucun utilisateur trouvé.</td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    }
  </div>
</div>
