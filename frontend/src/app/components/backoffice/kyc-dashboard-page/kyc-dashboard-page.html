<div class="min-h-screen bg-secondary px-4 py-8">
  <div class="max-w-6xl mx-auto">
    <div class="flex items-start justify-between gap-4 mb-6">
      <div>
        <h1 class="text-2xl font-bold text-primary">Backoffice KYC</h1>
        <p class="text-sm text-gray-600">Validation manuelle des niveaux KYC (0/1/2) + provisioning wallet (à partir de KYC1)</p>
      </div>
      <button
        type="button"
        class="px-4 py-2 rounded-lg bg-tertiary text-secondary hover:bg-quaternary transition"
        (click)="refresh()"
        [disabled]="loading()"
      >
        Rafraîchir
      </button>
    </div>

    <div class="bg-white rounded-xl shadow-md border border-gray-200 p-4 mb-5">
      <div class="flex flex-col sm:flex-row gap-3 items-start sm:items-end">
        <div class="w-full sm:w-96">
          <label class="block text-sm font-medium text-primary mb-2">Recherche (email / nom / entreprise / id)</label>
          <input
            class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-tertiary focus:border-tertiary"
            [ngModel]="q()"
            (ngModelChange)="q.set($event)"
            placeholder="souhail, esprit, ..."
          />
        </div>
        <button
          type="button"
          class="px-4 py-2 rounded-lg bg-[#00204A] text-white hover:bg-blue-900 transition"
          (click)="refresh()"
          [disabled]="loading()"
        >
          Chercher
        </button>
      </div>
    </div>

    @if (error()) {
      <div class="mb-4 rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-700">
        {{ error() }}
      </div>
    }

    @if (actionMsg()) {
      <div class="mb-4 rounded-lg border border-green-200 bg-green-50 px-4 py-3 text-sm text-green-700">
        {{ actionMsg() }}
      </div>
    }

    @if (loading()) {
      <div class="text-gray-600 text-sm">Chargement…</div>
    }

    <div class="bg-white rounded-xl shadow-md border border-gray-200 p-4">
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="border-b border-gray-200">
              <th class="text-left py-2 pr-3 text-primary">Utilisateur</th>
              <th class="text-left py-2 pr-3 text-primary">Type</th>
              <th class="text-left py-2 pr-3 text-primary">KYC</th>
              <th class="text-left py-2 pr-3 text-primary">Wallet</th>
              <th class="text-right py-2 text-primary">Actions</th>
            </tr>
          </thead>
          <tbody>
            @for (u of rows(); track u.id) {
              <tr class="border-b border-gray-100 align-top">
                <td class="py-3 pr-3">
                  <div class="font-medium text-primary">{{ u.email }}</div>
                  <div class="text-xs text-gray-500 font-mono break-all">{{ u.id }}</div>
                  <div class="text-xs text-gray-500">
                    Créé: {{ u.createdAt ? (u.createdAt | date:'yyyy-MM-dd HH:mm') : '-' }}
                  </div>
                  <div class="text-xs text-gray-500">
                    Résidence: {{ u.resident === null ? '-' : (u.resident ? 'Tunisien (Résident)' : 'Non-résident') }}
                  </div>
                </td>
                <td class="py-3 pr-3 text-gray-700">
                  {{ u.type ?? '-' }}
                </td>
                <td class="py-3 pr-3">
                  <span class="inline-flex items-center px-2 py-1 rounded-full border text-xs font-semibold" [class]="badge(u.kycLevel).cls">
                    {{ badge(u.kycLevel).label }}
                  </span>
                  <div class="text-xs text-gray-500 mt-1">
                    Validé: {{ u.kycValidatedAt ? (u.kycValidatedAt | date:'yyyy-MM-dd HH:mm') : '-' }}
                  </div>
                </td>
                <td class="py-3 pr-3">
                  @if (u.walletAddress) {
                    <div class="font-mono text-xs break-all text-gray-700">{{ u.walletAddress }}</div>
                  } @else {
                    <div class="text-xs text-gray-500">Non provisionné</div>
                  }
                </td>
                <td class="py-3 text-right">
                  <div class="inline-flex flex-col gap-2 items-end">
                    <button
                      type="button"
                      class="px-3 py-1.5 rounded-lg border border-gray-200 text-gray-800 hover:bg-gray-50 transition text-xs font-medium disabled:opacity-50"
                      (click)="setLevel(u, 0)"
                      [disabled]="loading() || !canSet(u, 0)"
                    >
                      Mettre KYC0
                    </button>
                    <button
                      type="button"
                      class="px-3 py-1.5 rounded-lg border border-yellow-200 text-yellow-900 hover:bg-yellow-50 transition text-xs font-medium disabled:opacity-50"
                      (click)="setLevel(u, 1)"
                      [disabled]="loading() || !canSet(u, 1)"
                    >
                      Valider KYC1
                    </button>
                    <button
                      type="button"
                      class="px-3 py-1.5 rounded-lg border border-green-200 text-green-900 hover:bg-green-50 transition text-xs font-medium disabled:opacity-50"
                      (click)="setLevel(u, 2)"
                      [disabled]="loading() || !canSet(u, 2)"
                    >
                      Valider KYC2
                    </button>
                  </div>
                </td>
              </tr>
            } @empty {
              <tr>
                <td colspan="5" class="py-10 text-center text-gray-500">
                  Aucun utilisateur trouvé.
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

