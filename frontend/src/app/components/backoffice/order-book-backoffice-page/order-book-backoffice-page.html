<div class="min-h-screen fc-premium-bg">
  <app-navbar-client></app-navbar-client>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="mb-4">
      <app-back-button fallbackRoute="/backoffice/audit"></app-back-button>
    </div>
    <div class="bo-card">
      <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
        <div>
          <h1 class="text-2xl font-bold text-white">Order Book P2P & Fallback</h1>
          <p class="text-sm text-white/60">Surveillance du marché hybride : ordres en attente, matching P2P, audit des bascules vers la piscine</p>
        </div>
        <button
          type="button"
          class="bo-btn"
          (click)="refresh()"
          [disabled]="loading()">
          Actualiser
        </button>
      </div>

      @if (error()) {
        <div class="mt-4 bo-error">{{ error() }}</div>
      }

      @if (loading()) {
        <div class="mt-4 bo-card flex items-center justify-center py-12">
          <div class="flex flex-col items-center gap-3">
            <div class="bo-spinner"></div>
            <span class="text-sm text-white/60">Chargement…</span>
          </div>
        </div>
      }

      @if (!loading()) {
        <!-- Tabs -->
        <div class="mt-6 bo-tabs">
          <button
            type="button"
            class="bo-tab"
            [class.bo-tab-active]="activeTab() === 'pending'"
            (click)="setTab('pending')">
            Ordres en attente ({{ pendingOrders().length }}) — TTL
          </button>
          <button
            type="button"
            class="bo-tab"
            [class.bo-tab-active]="activeTab() === 'matched'"
            (click)="setTab('matched')">
            Log de matching P2P ({{ matchedOrders().length }})
          </button>
          <button
            type="button"
            class="bo-tab"
            [class.bo-tab-active]="activeTab() === 'fallback'"
            (click)="setTab('fallback')">
            Audit bascule / Fallback ({{ fallbackOrders().length }})
          </button>
        </div>

        <!-- Tab: Pending -->
        @if (activeTab() === 'pending') {
          <div class="overflow-x-auto">
            <h2 class="text-lg font-semibold text-white mb-3">Ordres en attente (Time-to-Live)</h2>
            <table class="bo-table">
              <thead>
                <tr>
                  <th>Order ID</th>
                  <th>Maker</th>
                  <th>Side</th>
                  <th>Token</th>
                  <th class="text-right">Montant</th>
                  <th class="text-right">Prix</th>
                  <th>Créé</th>
                  <th class="text-right">TTL restant</th>
                  <th>Expire à</th>
                </tr>
              </thead>
              <tbody>
                @for (o of pendingOrders(); track o.orderId) {
                  <tr>
                    <td class="font-mono text-xs" [title]="o.orderId">{{ o.orderId.length > 16 ? o.orderId.slice(0,8) + '…' + o.orderId.slice(-4) : o.orderId }}</td>
                    <td class="font-mono text-xs break-all">{{ formatAddress(o.maker) }}</td>
                    <td>
                      <span [class.text-green-400]="o.side === 'BUY'" [class.text-red-400]="o.side === 'SELL'">{{ o.side }}</span>
                    </td>
                    <td class="font-medium">{{ o.tokenSymbol }}</td>
                    <td class="text-right">{{ from1e8(o.tokenAmount) | number:'1.2-2' }}</td>
                    <td class="text-right">{{ from1e8(o.pricePerToken) | number:'1.2-2' }} TND</td>
                    <td class="text-white/60">{{ o.createdAt | date:'short' }}</td>
                    <td class="text-right font-semibold" [class.text-amber-400]="(o.ttLSeconds ?? 0) < 3600">{{ formatTtl(o.ttLSeconds) }}</td>
                    <td class="text-white/60">{{ o.deadline * 1000 | date:'short' }}</td>
                  </tr>
                }
                @empty {
                  <tr>
                    <td colspan="9" class="py-8 text-center text-white/50">Aucun ordre en attente.</td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        }

        <!-- Tab: Matched -->
        @if (activeTab() === 'matched') {
          <div class="overflow-x-auto">
            <h2 class="text-lg font-semibold text-white mb-3">Historique des ordres matchés en P2P</h2>
            <table class="bo-table">
              <thead>
                <tr>
                  <th>Order ID</th>
                  <th>Maker</th>
                  <th>Side</th>
                  <th>Token</th>
                  <th class="text-right">Montant</th>
                  <th class="text-right">Matché</th>
                  <th>Match Order ID</th>
                  <th>Créé</th>
                  <th class="font-mono text-xs">Tx Hash</th>
                </tr>
              </thead>
              <tbody>
                @for (o of matchedOrders(); track o.orderId) {
                  <tr>
                    <td class="font-mono text-xs" [title]="o.orderId">{{ o.orderId.length > 16 ? o.orderId.slice(0,8) + '…' + o.orderId.slice(-4) : o.orderId }}</td>
                    <td class="font-mono text-xs break-all">{{ formatAddress(o.maker) }}</td>
                    <td>
                      <span [class.text-green-400]="o.side === 'BUY'" [class.text-red-400]="o.side === 'SELL'">{{ o.side }}</span>
                    </td>
                    <td class="font-medium">{{ o.tokenSymbol }}</td>
                    <td class="text-right">{{ from1e8(o.tokenAmount) | number:'1.2-2' }}</td>
                    <td class="text-right">{{ from1e8(o.filledTokenAmount ?? '0') | number:'1.2-2' }}</td>
                    <td class="font-mono text-xs" [title]="o.matchedOrderId ?? ''">{{ o.matchedOrderId ? (o.matchedOrderId.length > 16 ? o.matchedOrderId.slice(0,8) + '…' + o.matchedOrderId.slice(-4) : o.matchedOrderId) : '—' }}</td>
                    <td class="text-white/60">{{ o.createdAt | date:'short' }}</td>
                    <td class="font-mono text-xs break-all text-white/50">{{ o.settlementTxHash || '—' }}</td>
                  </tr>
                }
                @empty {
                  <tr>
                    <td colspan="9" class="py-8 text-center text-white/50">Aucun ordre matché en P2P.</td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        }

        <!-- Tab: Fallback -->
        @if (activeTab() === 'fallback') {
          <div class="overflow-x-auto">
            <h2 class="text-lg font-semibold text-white mb-3">Audit des ordres transférés vers la piscine</h2>
            <p class="text-xs text-white/50 mb-3">Ordres expirés sans matching P2P, exécutés via la piscine de liquidité ou échoués.</p>
            <table class="bo-table">
              <thead>
                <tr>
                  <th>Order ID</th>
                  <th>Maker</th>
                  <th>Side</th>
                  <th>Token</th>
                  <th class="text-right">Montant</th>
                  <th>Statut</th>
                  <th>Résultat Fallback</th>
                  <th>Créé</th>
                  <th class="font-mono text-xs">Tx Hash</th>
                </tr>
              </thead>
              <tbody>
                @for (o of fallbackOrders(); track o.orderId) {
                  <tr>
                    <td class="font-mono text-xs" [title]="o.orderId">{{ o.orderId.length > 16 ? o.orderId.slice(0,8) + '…' + o.orderId.slice(-4) : o.orderId }}</td>
                    <td class="font-mono text-xs break-all">{{ formatAddress(o.maker) }}</td>
                    <td>
                      <span [class.text-green-400]="o.side === 'BUY'" [class.text-red-400]="o.side === 'SELL'">{{ o.side }}</span>
                    </td>
                    <td class="font-medium">{{ o.tokenSymbol }}</td>
                    <td class="text-right">{{ from1e8(o.tokenAmount) | number:'1.2-2' }}</td>
                    <td>
                      <span [class.text-green-400]="o.status === 'SETTLED'" [class.text-red-400]="o.status === 'EXPIRED'">{{ o.status }}</span>
                    </td>
                    <td>
                      @if (o.fallbackSuccess === true) {
                        <span class="text-green-400 font-medium">Exécuté (piscine)</span>
                      } @else if (o.fallbackSuccess === false) {
                        <span class="text-red-400 font-medium">Échoué</span>
                      } @else {
                        <span class="text-white/40">—</span>
                      }
                    </td>
                    <td class="text-white/60">{{ o.createdAt | date:'short' }}</td>
                    <td class="font-mono text-xs break-all text-white/50">{{ o.settlementTxHash || '—' }}</td>
                  </tr>
                }
                @empty {
                  <tr>
                    <td colspan="9" class="py-8 text-center text-white/50">Aucun ordre basculé vers la piscine.</td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        }
      }
    </div>
  </main>
</div>
