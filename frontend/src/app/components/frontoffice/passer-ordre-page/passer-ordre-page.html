<div class="min-h-screen fc-premium-bg">
  <!-- Navbar -->
  <app-navbar-client></app-navbar-client>

  <!-- Main Content -->
  <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="mb-4">
      <app-back-button fallbackRoute="/acceuil-client"></app-back-button>
    </div>
    <div class="bg-white/95 backdrop-blur rounded-2xl shadow-[0_20px_60px_rgba(15,23,42,0.12)] ring-1 ring-white/30 p-6 sm:p-8">
    <!-- Header -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-gray-900 mb-2">
        {{ (orderType() === 'buy' ? 'Acheter' : 'Vendre') }} {{ tokenLabel() || 'CPEF' }}
      </h1>
      <p class="text-gray-600">
        Symbole: <span class="font-semibold">{{ tokenSymbol() }}</span>
        · Prix (VNI): <span class="font-semibold">{{ currentPrice() | number:'1.2-2' }} TND</span>
      </p>
        @if (quoteError()) {
          <p class="mt-2 text-sm text-red-600">{{ quoteError() }}</p>
        }
        @if (submitMessage()) {
          <p class="mt-2 text-sm text-green-700">{{ submitMessage() }}</p>
        }
    </div>

    <!-- Order Mode Toggle -->
    <div class="bg-white rounded-xl shadow-md p-6 mb-6 border border-gray-200">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold text-gray-900">Mode d'exécution</h2>
        <button
          (click)="toggleOrderMode()"
          [class]="orderMode() === 'piscine' 
            ? 'bg-[#22c55e] text-white' 
            : 'bg-[#00204A] text-white'"
          class="px-6 py-3 rounded-lg font-medium transition duration-150 ease-in-out flex items-center gap-2"
        >
          <span>{{ orderMode() === 'piscine' ? 'Piscine de Liquidité' : 'P2P' }}</span>
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
          </svg>
        </button>
      </div>
      <div class="bg-gray-50 rounded-lg p-4">
        <p class="text-sm text-gray-600">
          @if (orderMode() === 'piscine') {
            <span class="font-semibold text-[#22c55e]">Piscine de Liquidité:</span> Exécution immédiate au prix du marché
          } @else {
            <span class="font-semibold text-[#00204A]">P2P Hybrid Order Book:</span> Correspondance avec d'autres traders. À l'expiration, le reliquat non matché est exécuté via la piscine.
          }
        </p>
      </div>

      @if (orderMode() === 'p2p') {
        <div class="mt-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">Période de validité</label>
          <div class="flex gap-2">
            @for (p of validityPeriodOptions; track p) {
              <button
                type="button"
                (click)="selectValidityPeriod(p)"
                [class]="validityPeriod() === p 
                  ? 'px-4 py-2 rounded-lg text-sm font-medium text-white bg-[#00204A]' 
                  : 'px-4 py-2 rounded-lg text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200'"
              >
                {{ p === '24h' ? '24 heures' : p === '48h' ? '48 heures' : '7 jours' }}
              </button>
            }
          </div>
        </div>
      }
    </div>

    <!-- Amount Input Section -->
    <div class="bg-white rounded-xl shadow-md p-6 mb-6 border border-gray-200">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">Montant</h2>
      
      <!-- Amount Type Toggle -->
      <div class="flex gap-2 mb-4 p-1 bg-gray-100 rounded-lg">
        <button
          (click)="amountType.set('tnd')"
          [class]="amountType() === 'tnd' 
            ? 'flex-1 py-2 px-4 rounded-md text-sm font-medium text-white bg-[#00204A] transition duration-150 ease-in-out' 
            : 'flex-1 py-2 px-4 rounded-md text-sm font-medium text-gray-700 bg-transparent hover:bg-gray-200 transition duration-150 ease-in-out'"
        >
          En TND
        </button>
        <button
          (click)="amountType.set('tokens')"
          [class]="amountType() === 'tokens' 
            ? 'flex-1 py-2 px-4 rounded-md text-sm font-medium text-white bg-[#00204A] transition duration-150 ease-in-out' 
            : 'flex-1 py-2 px-4 rounded-md text-sm font-medium text-gray-700 bg-transparent hover:bg-gray-200 transition duration-150 ease-in-out'"
        >
          En Tokens
        </button>
      </div>

      <!-- Amount Input -->
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">
          Montant {{ amountType() === 'tnd' ? '(TND)' : '(Tokens)' }}
        </label>
        <input
          type="number"
          step="0.01"
          min="0"
          [ngModel]="amount()"
          (ngModelChange)="amount.set($event)"
          (input)="onAmountChange()"
          class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-[#00204A] focus:border-[#00204A] transition duration-150 ease-in-out text-lg"
          placeholder="0.00"
        />
      </div>

      <!-- Conversion Display -->
      @if (amount() > 0) {
        <div class="bg-gray-50 rounded-lg p-4 mb-4">
          <div class="flex justify-between items-center text-sm">
            <span class="text-gray-600">
              @if (amountType() === 'tnd') {
                {{ amount() | number:'1.2-2' }} TND = {{ tokenAmount() | number:'1.4-4' }} tokens
              } @else {
                {{ amount() | number:'1.4-4' }} tokens = {{ tndAmount() | number:'1.2-2' }} TND
              }
            </span>
          </div>
        </div>
      }

      <!-- Vérification des frais piscine -->
      @if (orderMode() === 'piscine' && amount() > 0 && poolFeesWarning()) {
        <div class="mt-4 p-3 bg-amber-50 border border-amber-200 rounded-lg">
          <p class="text-sm text-amber-800">⚠️ {{ poolFeesWarning() }}</p>
        </div>
      }

      <!-- Fees Calculator -->
      @if (amount() > 0) {
        <div class="border-t border-gray-200 pt-4">
          <div class="space-y-2 text-sm">
            <div class="flex justify-between">
              <span class="text-gray-600">Montant {{ amountType() === 'tnd' ? 'TND' : 'en TND' }}:</span>
              <span class="font-medium text-gray-900">{{ tndAmount() | number:'1.2-2' }} TND</span>
            </div>
            <div class="flex justify-between">
              <span class="text-gray-600">
                @if (orderMode() === 'piscine') {
                  Frais + TVA (quote):
                } @else {
                  Frais de transaction ({{ p2pFeePercent() }}%):
                }
              </span>
              <span class="font-medium text-gray-900">-{{ fees() | number:'1.2-2' }} TND</span>
            </div>
            <div class="flex justify-between pt-2 border-t border-gray-200">
              <span class="font-semibold text-gray-900">
                {{ orderType() === 'buy' ? 'Total à débiter' : 'Total à créditer' }}:
              </span>
              <span [class]="orderType() === 'buy' ? 'font-bold text-red-600' : 'font-bold text-green-600'">
                {{ orderType() === 'buy' ? '-' : '+' }}{{ totalCost() | number:'1.2-2' }} TND
              </span>
            </div>
          </div>
        </div>
      }
    </div>

    <!-- Cash Wallet / Credit Wallet Impact -->
    <div class="bg-white rounded-xl shadow-md p-6 mb-6 border border-gray-200">
      <h2 class="text-lg font-semibold text-gray-900 mb-4">
        @if (orderType() === 'buy' && creditDebt() > 0 && cashBalance() > 0) {
          Source de paiement : Cash Wallet ou Credit Wallet
        } @else {
          Impact sur le Cash Wallet
        }
      </h2>
      @if (orderType() === 'buy' && creditDebt() > 0 && cashBalance() > 0) {
        <div class="mb-4 space-y-3">
          <label class="flex items-center gap-3 cursor-pointer p-3 bg-blue-50 rounded-lg border border-blue-100">
            <input
              type="checkbox"
              [checked]="priorityCredit()"
              (change)="priorityCredit.set(!priorityCredit())"
              class="w-4 h-4 text-[#00204A] rounded border-gray-300 focus:ring-[#00204A]"
            />
            <span class="text-sm font-medium text-gray-900">
              Priorité Crédit (Recommandée)
            </span>
            <span class="text-xs text-gray-600">
              Utiliser le Credit Wallet en premier, compléter avec le Cash Wallet
            </span>
          </label>
          @if (totalCost() > 0) {
            <p class="text-sm text-gray-700">
              <strong>Répartition :</strong>
              <span class="text-[#00204A]">Credit Wallet : {{ fromCreditWallet() | number:'1.2-2' }} TND</span>
              @if (fromCashWallet() > 0) {
                <span> · </span>
                <span>Cash Wallet : {{ fromCashWallet() | number:'1.2-2' }} TND</span>
              }
            </p>
          }
        </div>
      }
      <div class="grid grid-cols-2 gap-4">
        <div class="bg-gray-50 rounded-lg p-4">
          <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Solde actuel</p>
          <p class="text-2xl font-bold text-gray-900">{{ cashBalance() | number:'1.2-2' }} TND</p>
          @if (creditDebt() > 0) {
            <p class="text-xs text-gray-500 mt-1">Credit : {{ creditDisplay() | number:'1.2-2' }} TND · Cash : {{ cashDisplay() | number:'1.2-2' }} TND</p>
          }
          @if (orderType() === 'buy' && p2pReservedCash() > 0) {
            <p class="text-xs text-amber-600 mt-1">Disponible : {{ availableCash() | number:'1.2-2' }} TND ({{ p2pReservedCash() | number:'1.2-2' }} TND réservés par ordres P2P)</p>
          }
        </div>
        <div [class]="orderType() === 'buy' ? 'bg-red-50 rounded-lg p-4' : 'bg-green-50 rounded-lg p-4'">
          <p class="text-xs text-gray-500 uppercase tracking-wide mb-1">Solde après transaction</p>
          <p [class]="orderType() === 'buy' ? 'text-2xl font-bold text-red-600' : 'text-2xl font-bold text-green-600'">
            {{ cashAfter() | number:'1.2-2' }} TND
          </p>
        </div>
      </div>
      @if (orderType() === 'buy' && p2pReservedCash() > 0) {
        <p class="text-xs text-gray-500 mt-2">Réservé par ordres P2P en attente : {{ p2pReservedCash() | number:'1.2-2' }} TND</p>
      }
      @if (orderType() === 'buy' && (cashAfter() < 0 || cashBalance() === 0 || totalCost() > availableCash())) {
        <div class="mt-4 p-3 bg-amber-50 border border-amber-200 rounded-lg">
          <p class="text-sm text-amber-800 mb-3">
            ⚠️ Solde insuffisant. @if (p2pReservedCash() > 0) {
              {{ p2pReservedCash() | number:'1.2-2' }} TND sont réservés par vos ordres P2P en attente.
            }
            Alimentez votre Cash Wallet pour effectuer vos transactions.
          </p>
          <button
            (click)="onSeedCash()"
            [disabled]="isSeeding()"
            class="px-4 py-2 bg-[#22c55e] text-white rounded-lg font-medium hover:bg-green-600 disabled:opacity-50 disabled:cursor-not-allowed transition"
          >
            {{ isSeeding() ? 'Alimentation...' : 'Alimenter 10 000 TND' }}
          </button>
        </div>
      }
    </div>

    <!-- Action Buttons -->
    <div class="flex gap-4">
      <button
        (click)="onCancel()"
        class="flex-1 px-6 py-3 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 transition duration-150 ease-in-out"
      >
        Annuler
      </button>
      <button
        (click)="onConfirm()"
        [disabled]="!canConfirm()"
        [class]="canConfirm() 
          ? (orderType() === 'buy' 
            ? 'flex-1 px-6 py-3 bg-[#22c55e] text-white rounded-lg font-medium hover:bg-green-600 transition duration-150 ease-in-out transform hover:scale-105'
            : 'flex-1 px-6 py-3 bg-[#00204A] text-white rounded-lg font-medium hover:bg-blue-900 transition duration-150 ease-in-out transform hover:scale-105')
          : 'flex-1 px-6 py-3 bg-gray-400 text-white rounded-lg font-medium cursor-not-allowed opacity-50'"
      >
        @if (isSubmitting()) {
          Envoi...
        } @else {
          Confirmer l'ordre
        }
      </button>
    </div>

    <app-confirm-order-modal
      [open]="isConfirmOpen()"
      [summary]="confirmSummary()"
      [isSubmitting]="isSubmitting()"
      [error]="quoteError()"
      (close)="isConfirmOpen.set(false)"
      (confirm)="onConfirmModal()"
    ></app-confirm-order-modal>
    </div>
  </main>
</div>
